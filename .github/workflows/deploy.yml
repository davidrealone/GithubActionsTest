name: CI/CD Pipeline
on:
  push:
    branches: [main]

jobs:
  build-test:
    name: Build and Test
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          pnpm install
          echo "ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Run tests
        run: pnpm run test:unit
        env:
          CI: true

      - name: Build project
        run: |
          pnpm run build
          echo "æ„å»ºå®Œæˆï¼Œäº§ç‰©å¤§å°ï¼š"
          du -sh dist/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            dist/
            !dist/**/*.map
          retention-days: 7

  deploy:
    name: Deploy to Production
    needs: build-test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build

      - name: Verify artifacts
        run: |
          echo "ä¸‹è½½çš„äº§ç‰©å†…å®¹ï¼š"
          ls -la
          echo "æ–‡ä»¶æ€»æ•°ï¼š$(find . -type f | wc -l)"

      - name: Setup SSH Configuration
        run: |
          echo "=== é…ç½®SSHè¿æ¥ ==="

          # è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
          CURRENT_USER=$(whoami)
          echo "å½“å‰æ‰§è¡Œç”¨æˆ·: $CURRENT_USER"

          # è®¾ç½®æ­£ç¡®çš„HOMEç›®å½•
          if [ "$CURRENT_USER" = "root" ]; then
            export HOME=/root
          else
            export HOME=/home/$CURRENT_USER
          fi
          echo "HOMEç›®å½•: $HOME"

          # åˆ›å»ºSSHç›®å½•
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # æ¸…ç†æ—§çš„å¯†é’¥æ–‡ä»¶
          rm -f ~/.ssh/id_ed25519 ~/.ssh/id_ed25519.pub ~/.ssh/deploy_key

          # å°è¯•ä½¿ç”¨github-runnerçš„å¯†é’¥
          RUNNER_KEY="/home/github-runner/.ssh/id_ed25519"
          RUNNER_PUB_KEY="/home/github-runner/.ssh/id_ed25519.pub"

          echo "æ£€æŸ¥github-runnerå¯†é’¥..."
          if [ -f "$RUNNER_KEY" ] && [ -f "$RUNNER_PUB_KEY" ]; then
            echo "ä½¿ç”¨github-runnerçš„SSHå¯†é’¥å¯¹"
            # å¤åˆ¶ç§é’¥
            cp "$RUNNER_KEY" ~/.ssh/id_ed25519
            # å¤åˆ¶å…¬é’¥
            cp "$RUNNER_PUB_KEY" ~/.ssh/id_ed25519.pub
            chmod 600 ~/.ssh/id_ed25519
            chmod 644 ~/.ssh/id_ed25519.pub
            
            # æ˜¾ç¤ºå…¬é’¥ï¼ˆç”¨äºç›®æ ‡æœåŠ¡å™¨é…ç½®ï¼‰
            echo "å…¬é’¥å†…å®¹ï¼ˆéœ€è¦åœ¨ç›®æ ‡æœåŠ¡å™¨æ·»åŠ åˆ°æ­¤æ–‡ä»¶ï¼‰:"
            echo "~/.ssh/authorized_keys"
            cat ~/.ssh/id_ed25519.pub
          else
            echo "ä½¿ç”¨GitHub Secretsçš„SSHå¯†é’¥"
            # ä»GitHub Secretsè¯»å–ç§é’¥
            echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            
            # å¦‚æœæœ‰å…¬é’¥Secretï¼Œä¹Ÿä½¿ç”¨å®ƒ
            if [ -n "${{ secrets.DEPLOY_SSH_PUB_KEY }}" ]; then
              echo "${{ secrets.DEPLOY_SSH_PUB_KEY }}" > ~/.ssh/id_ed25519.pub
              chmod 644 ~/.ssh/id_ed25519.pub
            else
              # ä»ç§é’¥ç”Ÿæˆå…¬é’¥
              ssh-keygen -y -f ~/.ssh/id_ed25519 > ~/.ssh/id_ed25519.pub 2>/dev/null || true
            fi
          fi

          # éªŒè¯å¯†é’¥
          echo "éªŒè¯SSHå¯†é’¥..."
          if [ -f ~/.ssh/id_ed25519 ]; then
            KEY_FINGERPRINT=$(ssh-keygen -l -f ~/.ssh/id_ed25519 2>/dev/null || echo "æ— æ³•è¯»å–å¯†é’¥")
            echo "å¯†é’¥æŒ‡çº¹: $KEY_FINGERPRINT"
          else
            echo "âŒ é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°SSHç§é’¥"
            exit 1
          fi

          # åˆ›å»ºSSHé…ç½®æ–‡ä»¶
          cat > ~/.ssh/config << 'EOF'
          Host deploy-production
            HostName 192.168.1.78
            User fuint
            Port 22
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ConnectTimeout 30
            ServerAliveInterval 60
            ServerAliveCountMax 3
            IdentitiesOnly yes
            PreferredAuthentications publickey
            LogLevel INFO
          EOF

          chmod 600 ~/.ssh/config

          echo "SSHé…ç½®å®Œæˆ"
          echo "é…ç½®æ–‡ä»¶å†…å®¹:"
          cat ~/.ssh/config

      - name: Test SSH Connection
        run: |
          echo "=== æµ‹è¯•SSHè¿æ¥ ==="

          # æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
          echo "è¿æ¥ä¿¡æ¯:"
          echo "ç›®æ ‡ä¸»æœº: 192.168.1.78"
          echo "ç›®æ ‡ç”¨æˆ·: fuint"
          echo "ä½¿ç”¨å¯†é’¥: ~/.ssh/id_ed25519"

          # ç¬¬ä¸€æ¬¡æµ‹è¯•ï¼ˆå¯èƒ½è¾ƒæ…¢ï¼‰
          echo "æ­£åœ¨è¿›è¡ŒSSHè¿æ¥æµ‹è¯•..."

          # ä½¿ç”¨è¯¦ç»†æ¨¡å¼æµ‹è¯•è¿æ¥
          CONNECT_RESULT=$(ssh -T deploy-production "echo 'SSHè¿æ¥æˆåŠŸ'" 2>&1)
          CONNECT_EXIT_CODE=$?

          if [ $CONNECT_EXIT_CODE -eq 0 ]; then
            echo "âœ… SSHè¿æ¥æµ‹è¯•æˆåŠŸ"
            echo "è¾“å‡º: $CONNECT_RESULT"
          else
            echo "âŒ SSHè¿æ¥æµ‹è¯•å¤±è´¥"
            echo "é”™è¯¯ä»£ç : $CONNECT_EXIT_CODE"
            echo "é”™è¯¯ä¿¡æ¯:"
            echo "$CONNECT_RESULT"
            
            # å°è¯•æ›´è¯¦ç»†çš„è°ƒè¯•
            echo "=== è¯¦ç»†è°ƒè¯•ä¿¡æ¯ ==="
            ssh -vvv -T deploy-production "exit" 2>&1 | tail -20
            
            # æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ å…¬é’¥åˆ°ç›®æ ‡æœåŠ¡å™¨
            echo ""
            echo "âš ï¸ å¯èƒ½éœ€è¦å°†ä»¥ä¸‹å…¬é’¥æ·»åŠ åˆ°ç›®æ ‡æœåŠ¡å™¨çš„ authorized_keys:"
            cat ~/.ssh/id_ed25519.pub 2>/dev/null || echo "æ— æ³•è¯»å–å…¬é’¥"
            
            exit 1
          fi

      - name: Deploy files
        env:
          DEPLOY_PATH: /home/fuint/frontsite
        run: |
          echo "å¼€å§‹éƒ¨ç½²åˆ°ç›®æ ‡æœåŠ¡å™¨..."
          echo "ç›®æ ‡è·¯å¾„: $DEPLOY_PATH"

          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          echo "åˆ›å»ºç›®æ ‡ç›®å½•..."
          ssh deploy-production "mkdir -p $DEPLOY_PATH"

          # æ˜¾ç¤ºåŒæ­¥å‰çŠ¶æ€
          echo "åŒæ­¥å‰ç›®æ ‡ç›®å½•çŠ¶æ€:"
          ssh deploy-production "ls -la $DEPLOY_PATH/ | head -10"

          # ä½¿ç”¨rsyncéƒ¨ç½²ï¼ˆè¯¦ç»†æ¨¡å¼ï¼‰
          echo "ä½¿ç”¨rsyncåŒæ­¥æ–‡ä»¶ä¸­..."
          rsync -avz --progress --delete \
            -e "ssh -F ~/.ssh/config" \
            --exclude='.git*' \
            --exclude='*.log' \
            --exclude='node_modules' \
            --exclude='.env*' \
            --exclude='*.map' \
            ./ \
            deploy-production:$DEPLOY_PATH/

          # æ£€æŸ¥rsyncé€€å‡ºçŠ¶æ€
          RSYNC_EXIT_CODE=$?
          if [ $RSYNC_EXIT_CODE -eq 0 ]; then
            echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ"
          else
            echo "âŒ æ–‡ä»¶åŒæ­¥å¤±è´¥ï¼Œé€€å‡ºä»£ç : $RSYNC_EXIT_CODE"
            exit $RSYNC_EXIT_CODE
          fi

      - name: Verify deployment
        run: |
          echo "=== éƒ¨ç½²éªŒè¯ ==="

          ssh deploy-production "
            echo 'ç›®æ ‡ç›®å½•: /home/fuint/frontsite'
            echo ''
            echo 'ç›®å½•å¤§å°:'
            du -sh /home/fuint/frontsite
            echo ''
            echo 'æ–‡ä»¶æ•°é‡ç»Ÿè®¡:'
            find /home/fuint/frontsite -type f | wc -l
            echo ''
            echo 'ç›®å½•ç»“æ„(å‰20ä¸ª):'
            ls -la /home/fuint/frontsite/ | head -21
            echo ''
            echo 'æ„å»ºäº§ç‰©éªŒè¯:'
            if [ -d '/home/fuint/frontsite/dist' ]; then
              echo 'âœ… distç›®å½•å­˜åœ¨'
              ls -la /home/fuint/frontsite/dist/ | head -6
            else
              echo 'âŒ distç›®å½•ä¸å­˜åœ¨'
            fi
          "

          echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆ"

      - name: Post-deployment tasks
        run: |
          echo "=== éƒ¨ç½²åä»»åŠ¡ ==="

          # ç¤ºä¾‹ï¼šå¦‚æœéœ€è¦é‡å¯æœåŠ¡æˆ–æ‰§è¡Œå…¶ä»–å‘½ä»¤
          # ssh deploy-production "cd /home/fuint/frontsite && pm2 reload frontsite || pm2 start npm --name 'frontsite' -- start"

          echo "ğŸ‰ CI/CD éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "é¡¹ç›®å·²éƒ¨ç½²åˆ°: 192.168.1.78:/home/fuint/frontsite"
          echo "éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "Commit: ${{ github.sha }}"
          echo "åˆ†æ”¯: ${{ github.ref }}"
