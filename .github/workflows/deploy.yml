name: CI/CD Pipeline
on:
  push:
    branches: [ main ]

jobs:
  build-test:
    name: Build and Test
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: |
          pnpm install
          echo "ä¾èµ–å®‰è£…å®Œæˆ"
      
      - name: Run tests
        run: pnpm run test:unit
        env:
          CI: true
      
      - name: Build project
        run: |
          pnpm run build
          echo "æ„å»ºå®Œæˆï¼Œäº§ç‰©å¤§å°ï¼š"
          du -sh dist/ || true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            dist/
            !dist/**/*.map  # æ’é™¤source maps
          retention-days: 7

  deploy:
    name: Deploy to Production
    needs: build-test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build
      
      - name: Verify artifacts
        run: |
          echo "ä¸‹è½½çš„äº§ç‰©å†…å®¹ï¼š"
          ls -la
          echo "æ–‡ä»¶æ€»æ•°ï¼š$(find . -type f | wc -l)"
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # ç¦ç”¨ä¸»æœºå¯†é’¥æ£€æŸ¥ï¼ˆå†…ç½‘ç¯å¢ƒï¼‰
          echo -e "Host 192.168.1.78\n\tStrictHostKeyChecking no\n\tUserKnownHostsFile /dev/null" > ~/.ssh/config
          
          # æµ‹è¯•è¿æ¥
          ssh -o ConnectTimeout=5 fuint@192.168.1.78 "echo 'SSHè¿æ¥æµ‹è¯•æˆåŠŸ'" || true
      
      - name: Deploy files
        env:
          DEPLOY_HOST: 192.168.1.78
          DEPLOY_USER: fuint
          DEPLOY_PATH: /home/fuint/frontsite
        run: |
          echo "å¼€å§‹éƒ¨ç½²åˆ° $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH"
          
          # ä½¿ç”¨rsyncåŒæ­¥ï¼Œåªä¼ è¾“å˜åŒ–çš„æ–‡ä»¶
          rsync -avz --delete \
            --exclude='.git*' \
            --exclude='*.log' \
            ./ \
            $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
          
          echo "æ–‡ä»¶åŒæ­¥å®Œæˆ"
      
      - name: Post-deployment verification
        run: |
          ssh fuint@192.168.1.78 "
            echo '=== éƒ¨ç½²éªŒè¯ ==='
            echo 'ç›®æ ‡ç›®å½•: $DEPLOY_PATH'
            echo 'ç›®å½•å¤§å°:'
            du -sh $DEPLOY_PATH
            echo ''
            echo 'æœ€è¿‘ä¿®æ”¹çš„5ä¸ªæ–‡ä»¶:'
            find $DEPLOY_PATH -type f -printf '%T+ %p\n' | sort -r | head -5
            echo ''
            echo 'éƒ¨ç½²æ—¶é—´: $(date)'
          "
          
      - name: Notification
        run: |
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo "é¡¹ç›®å·²æˆåŠŸéƒ¨ç½²åˆ° 192.168.1.78"
          echo "è®¿é—®åœ°å€: http://192.168.1.78 (å¦‚æœé…ç½®äº†WebæœåŠ¡å™¨)"
