name: CI/CD Pipeline
on:
  push:
    branches: [main]

jobs:
  build-test:
    name: Build and Test
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          pnpm install
          echo "ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Run tests
        run: pnpm run test:unit
        env:
          CI: true

      - name: Build project
        run: |
          pnpm run build
          echo "æž„å»ºå®Œæˆï¼Œäº§ç‰©å¤§å°ï¼š"
          du -sh dist/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            dist/
            !dist/**/*.map
          retention-days: 7

  deploy:
    name: Deploy to Production
    needs: build-test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build

      - name: Verify artifacts
        run: |
          echo "ä¸‹è½½çš„äº§ç‰©å†…å®¹ï¼š"
          ls -la
          echo "æ–‡ä»¶æ€»æ•°ï¼š$(find . -type f | wc -l)"

      - name: Setup SSH using github-runner's key
        run: |
          echo "=== ä½¿ç”¨github-runnerç”¨æˆ·çš„å¯†é’¥ ==="

          # 1. ç¡®å®šå¯†é’¥æº
          SOURCE_KEY="/home/github-runner/.ssh/id_ed25519"
          TARGET_KEY="$HOME/.ssh/deploy_key"

          echo "æºå¯†é’¥: $SOURCE_KEY"
          echo "ç›®æ ‡å¯†é’¥: $TARGET_KEY"

          # 2. å¤åˆ¶å¯†é’¥
          mkdir -p ~/.ssh
          if [ -f "$SOURCE_KEY" ]; then
            echo "å¤åˆ¶github-runnerçš„å¯†é’¥..."
            cp "$SOURCE_KEY" "$TARGET_KEY"
          else
            echo "ä½¿ç”¨GitHub Secretsçš„å¯†é’¥..."
            cat > "$TARGET_KEY" << 'EOF'
          ${{ secrets.DEPLOY_SSH_KEY }}
          EOF
          fi

          # 3. è®¾ç½®æƒé™
          chmod 600 "$TARGET_KEY"

          # 4. éªŒè¯å¯†é’¥
          echo "éªŒè¯å¯†é’¥..."
          ssh-keygen -l -f "$TARGET_KEY" 2>/dev/null || {
            echo "âŒ å¯†é’¥æ— æ•ˆ"
            exit 1
          }

          # 5. é…ç½®SSH
          cat > ~/.ssh/config << 'EOF'
          Host deploy-target
            HostName 192.168.1.78
            User fuint
            IdentityFile $TARGET_KEY
            StrictHostKeyChecking no
            ConnectTimeout 10
            IdentitiesOnly yes
          EOF

          # 6. æµ‹è¯•è¿žæŽ¥
          echo "æµ‹è¯•è¿žæŽ¥..."
          ssh deploy-target "echo 'âœ… SSHè¿žæŽ¥æˆåŠŸ'"

      - name: Deploy files
        env:
          DEPLOY_PATH: /home/fuint/frontsite
        run: |
          echo "å¼€å§‹éƒ¨ç½²åˆ°ç›®æ ‡æœåŠ¡å™¨..."
          echo "ç›®æ ‡è·¯å¾„: $DEPLOY_PATH"

          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          ssh deploy-target "mkdir -p $DEPLOY_PATH"

          # ä½¿ç”¨rsyncéƒ¨ç½²
          echo "åŒæ­¥æ–‡ä»¶ä¸­..."
          rsync -avz --progress --delete \
            -e "ssh -F ~/.ssh/config" \
            --exclude='.git*' \
            --exclude='*.log' \
            ./ \
            deploy-target:$DEPLOY_PATH/

          echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ"

      - name: Verify deployment
        run: |
          echo "=== éƒ¨ç½²éªŒè¯ ==="

          # éªŒè¯æ–‡ä»¶æ•°é‡å’Œå¤§å°
          ssh deploy-target "
            echo 'ç›®æ ‡ç›®å½•: /home/fuint/frontsite'
            echo 'ç›®å½•å¤§å°:'
            du -sh /home/fuint/frontsite
            echo ''
            echo 'æ–‡ä»¶æ•°é‡:'
            find /home/fuint/frontsite -type f | wc -l
            echo ''
            echo 'å‰5ä¸ªæ–‡ä»¶:'
            ls -la /home/fuint/frontsite/ | head -6
          "

          echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆ"

      - name: Deployment success notification
        run: |
          echo "ðŸŽ‰ CI/CD éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "é¡¹ç›®å·²éƒ¨ç½²åˆ°: 192.168.1.78:/home/fuint/frontsite"
          echo "æ—¶é—´: $(date)"
