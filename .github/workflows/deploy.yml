name: CI/CD Pipeline
on:
  push:
    branches: [main]

jobs:
  build-test:
    name: Build and Test
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          pnpm install
          echo "ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Run tests
        run: pnpm run test:unit
        env:
          CI: true

      - name: Build project
        run: |
          pnpm run build
          echo "æ„å»ºå®Œæˆï¼Œäº§ç‰©å¤§å°ï¼š"
          du -sh dist/ || true
          echo "distç›®å½•å†…å®¹ï¼š"
          ls -la dist/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            dist/
            !dist/**/*.map
          retention-days: 7

  deploy:
    name: Deploy to Production
    needs: build-test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build

      - name: Verify build artifacts
        run: |
          echo "éªŒè¯æ„å»ºäº§ç‰©..."
          if [ ! -d "./dist" ]; then
            echo "âŒ é”™è¯¯: distç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

          echo "distç›®å½•å†…å®¹:"
          ls -la dist/
          echo "HTMLæ–‡ä»¶: $(find dist/ -name '*.html' | wc -l)ä¸ª"
          echo "JSæ–‡ä»¶: $(find dist/ -name '*.js' | wc -l)ä¸ª"
          echo "CSSæ–‡ä»¶: $(find dist/ -name '*.css' | wc -l)ä¸ª"

      - name: Setup SSH Connection
        run: |
          echo "=== é…ç½®SSHè¿æ¥ ==="

          CURRENT_USER=$(whoami)
          echo "å½“å‰ç”¨æˆ·: $CURRENT_USER"

          if [ "$CURRENT_USER" = "root" ]; then
            export HOME=/root
          else
            export HOME=/home/$CURRENT_USER
          fi

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          rm -f ~/.ssh/id_ed25519 ~/.ssh/id_ed25519.pub ~/.ssh/config

          cp /home/github-runner/.ssh/id_ed25519 ~/.ssh/
          cp /home/github-runner/.ssh/id_ed25519.pub ~/.ssh/
          chmod 600 ~/.ssh/id_ed25519
          chmod 644 ~/.ssh/id_ed25519.pub

          cat > ~/.ssh/config << 'EOF'
          Host 192.168.1.78
            HostName 192.168.1.78
            User fuint
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking no
            ConnectTimeout 15
          EOF

          chmod 600 ~/.ssh/config

      - name: Test SSH Connection
        run: |
          echo "æµ‹è¯•SSHè¿æ¥..."
          if ssh -o ConnectTimeout=10 192.168.1.78 "echo 'âœ… è¿æ¥æˆåŠŸ'"; then
            echo "âœ… SSHè¿æ¥æ­£å¸¸"
          else
            echo "âŒ SSHè¿æ¥å¤±è´¥"
            exit 1
          fi

      - name: Deploy dist directory
        env:
          DEPLOY_PATH: /home/fuint/frontsite
        run: |
          echo "=== éƒ¨ç½²distç›®å½• ==="
          echo "ç›®æ ‡: $DEPLOY_PATH"

          # æ£€æŸ¥ç›®æ ‡ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
          ssh 192.168.1.78 "mkdir -p $DEPLOY_PATH"

          # æ¸…ç†æ—§çš„distæ–‡ä»¶å¤¹ï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦æ¯æ¬¡å…¨æ–°éƒ¨ç½²ï¼‰
          # ssh 192.168.1.78 "rm -rf $DEPLOY_PATH/dist 2>/dev/null || true"

          echo "å¼€å§‹åŒæ­¥distæ–‡ä»¶å¤¹..."
          # ã€å…³é”®ä¿®æ”¹ç‚¹ï¼šdist åé¢æ²¡æœ‰æ–œæ ï¼Œè¿™æ ·ä¼šåŒæ­¥æ•´ä¸ªdistæ–‡ä»¶å¤¹ã€‘
          rsync -avz --progress \
            --exclude='*.map' \
            dist \  # â† æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰æ–œæ ï¼ŒåŒæ­¥æ•´ä¸ªdistæ–‡ä»¶å¤¹
            fuint@192.168.1.78:$DEPLOY_PATH/

          echo "âœ… éƒ¨ç½²å®Œæˆ"

      - name: Verify deployment
        run: |
          echo "=== éƒ¨ç½²éªŒè¯ ==="

          ssh 192.168.1.78 "
            echo 'ç›®æ ‡æœåŠ¡å™¨éªŒè¯:'
            echo '================'
            echo 'ç›®å½•ç»“æ„:'
            echo '/home/fuint/frontsite/'
            ls -la /home/fuint/frontsite/
            echo ''
            echo 'distç›®å½•å†…å®¹:'
            ls -la /home/fuint/frontsite/dist/
            echo ''
            echo 'æ–‡ä»¶ç»Ÿè®¡:'
            echo 'distç›®å½•å¤§å°: \$(du -sh /home/fuint/frontsite/dist/)'
            echo 'distç›®å½•æ–‡ä»¶æ•°: \$(find /home/fuint/frontsite/dist -type f | wc -l)'
            echo ''
            echo 'å…³é”®æ–‡ä»¶æ£€æŸ¥:'
            # ã€ç›¸åº”ä¿®æ”¹ï¼šæ–‡ä»¶è·¯å¾„åŠ ä¸Š dist/ å‰ç¼€ã€‘
            if [ -d '/home/fuint/frontsite/dist' ]; then
              [ -f '/home/fuint/frontsite/dist/index.html' ] && echo 'âœ… index.html å­˜åœ¨' || echo 'âŒ index.html ç¼ºå¤±'
              [ -f '/home/fuint/frontsite/dist/favicon.ico' ] && echo 'âœ… favicon.ico å­˜åœ¨' || echo 'âš ï¸  favicon.ico ç¼ºå¤±'
              echo 'HTMLæ–‡ä»¶æ•°: \$(find /home/fuint/frontsite/dist -name \"*.html\" | wc -l)'
              echo 'JSæ–‡ä»¶æ•°: \$(find /home/fuint/frontsite/dist -name \"*.js\" | wc -l)'
              echo 'CSSæ–‡ä»¶æ•°: \$(find /home/fuint/frontsite/dist -name \"*.css\" | wc -l)'
            else
              echo 'âŒ distç›®å½•ä¸å­˜åœ¨'
            fi
          "

          echo "âœ… éªŒè¯å®Œæˆ"

      - name: Deployment success
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "é¡¹ç›®å·²éƒ¨ç½²åˆ°: 192.168.1.78:/home/fuint/frontsite/dist/"
          echo "éƒ¨ç½²æ—¶é—´: $(date)"
          echo "Commit: ${{ github.sha }}"
