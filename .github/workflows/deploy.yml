name: CI/CD Pipeline
on:
  push:
    branches: [main]

jobs:
  build-test:
    name: Build and Test
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          pnpm install
          echo "ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Run tests
        run: pnpm run test:unit
        env:
          CI: true

      - name: Build project
        run: |
          pnpm run build
          echo "æ„å»ºå®Œæˆï¼Œäº§ç‰©å¤§å°ï¼š"
          du -sh dist/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            dist/
            !dist/**/*.map
          retention-days: 7

  deploy:
    name: Deploy to Production
    needs: build-test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build

      - name: Verify artifacts
        run: |
          echo "ä¸‹è½½çš„äº§ç‰©å†…å®¹ï¼š"
          ls -la
          echo "æ–‡ä»¶æ€»æ•°ï¼š$(find . -type f | wc -l)"

      - name: Setup SSH Connection
        run: |
          echo "=== é…ç½®SSHè¿æ¥ ==="

          # æ˜¾ç¤ºå½“å‰ç”¨æˆ·ä¿¡æ¯
          CURRENT_USER=$(whoami)
          echo "å½“å‰ç”¨æˆ·: $CURRENT_USER"

          # è®¾ç½®HOMEç›®å½•
          if [ "$CURRENT_USER" = "root" ]; then
            export HOME=/root
          else
            export HOME=/home/$CURRENT_USER
          fi
          echo "HOMEç›®å½•: $HOME"

          # åˆ›å»ºSSHç›®å½•
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§é…ç½®
          rm -f ~/.ssh/id_ed25519 ~/.ssh/id_ed25519.pub ~/.ssh/config

          # ç›´æ¥ä½¿ç”¨github-runnerçš„å¯†é’¥ï¼ˆå·²éªŒè¯æœ‰æ•ˆçš„ï¼‰
          echo "å¤åˆ¶github-runnerçš„SSHå¯†é’¥..."
          cp /home/github-runner/.ssh/id_ed25519 ~/.ssh/
          cp /home/github-runner/.ssh/id_ed25519.pub ~/.ssh/
          chmod 600 ~/.ssh/id_ed25519
          chmod 644 ~/.ssh/id_ed25519.pub

          # æ˜¾ç¤ºæ­£åœ¨ä½¿ç”¨çš„å…¬é’¥
          echo "ä½¿ç”¨çš„å…¬é’¥æŒ‡çº¹:"
          ssh-keygen -l -f ~/.ssh/id_ed25519

          # åˆ›å»ºç®€åŒ–çš„SSHé…ç½®æ–‡ä»¶
          cat > ~/.ssh/config << 'EOF'
          Host 192.168.1.78
            HostName 192.168.1.78
            User fuint
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ConnectTimeout 15
            ServerAliveInterval 30
          EOF

          chmod 600 ~/.ssh/config

          echo "SSHé…ç½®å®Œæˆ"

      - name: Test SSH Connection
        run: |
          echo "=== æµ‹è¯•SSHè¿æ¥ ==="

          # ç®€å•æµ‹è¯•è¿æ¥
          echo "æµ‹è¯•åˆ° 192.168.1.78 çš„è¿æ¥..."
          if ssh -o ConnectTimeout=10 192.168.1.78 "echo 'âœ… SSHè¿æ¥æˆåŠŸ'"; then
            echo "âœ… SSHè¿æ¥æµ‹è¯•é€šè¿‡"
          else
            echo "âŒ SSHè¿æ¥å¤±è´¥"
            
            # æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            echo ""
            echo "=== è°ƒè¯•ä¿¡æ¯ ==="
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "ç”¨æˆ·: $(whoami)"
            echo ""
            echo "å¯†é’¥æ–‡ä»¶:"
            ls -la ~/.ssh/
            echo ""
            echo "å…¬é’¥å†…å®¹ï¼ˆè¯·ç¡®è®¤ç›®æ ‡æœåŠ¡å™¨å·²æ·»åŠ æ­¤å…¬é’¥ï¼‰:"
            cat ~/.ssh/id_ed25519.pub
            
            exit 1
          fi

      - name: Deploy files
        env:
          DEPLOY_PATH: /home/fuint/frontsite
        run: |
          echo "å¼€å§‹éƒ¨ç½²åˆ°ç›®æ ‡æœåŠ¡å™¨..."
          echo "ç›®æ ‡è·¯å¾„: $DEPLOY_PATH"

          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          echo "æ£€æŸ¥/åˆ›å»ºç›®æ ‡ç›®å½•..."
          ssh 192.168.1.78 "mkdir -p $DEPLOY_PATH"

          # æ˜¾ç¤ºéƒ¨ç½²å‰çŠ¶æ€
          echo "éƒ¨ç½²å‰ç›®å½•çŠ¶æ€:"
          ssh 192.168.1.78 "ls -la $DEPLOY_PATH/ 2>/dev/null | head -5 || echo 'ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨'"

          # ä½¿ç”¨rsyncéƒ¨ç½²
          echo "ä½¿ç”¨rsyncåŒæ­¥æ–‡ä»¶..."
          rsync -avz --progress --delete \
            --exclude='.git*' \
            --exclude='*.log' \
            --exclude='node_modules' \
            --exclude='.env*' \
            --exclude='*.map' \
            ./ \
            fuint@192.168.1.78:$DEPLOY_PATH/

          echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ"

          # æ˜¾ç¤ºéƒ¨ç½²åçŠ¶æ€
          echo "éƒ¨ç½²åç›®å½•çŠ¶æ€:"
          ssh 192.168.1.78 "ls -la $DEPLOY_PATH/ | head -10"

      - name: Verify deployment
        run: |
          echo "=== éƒ¨ç½²éªŒè¯ ==="

          ssh 192.168.1.78 "
            echo 'éƒ¨ç½²éªŒè¯ä¿¡æ¯:'
            echo '================'
            echo 'ç›®å½•: /home/fuint/frontsite'
            echo ''
            echo 'ç›®å½•å¤§å°:'
            du -sh /home/fuint/frontsite
            echo ''
            echo 'æ–‡ä»¶æ•°é‡:'
            find /home/fuint/frontsite -type f | wc -l
            echo ''
            echo 'distç›®å½•å†…å®¹:'
            if [ -d '/home/fuint/frontsite/dist' ]; then
              echo 'âœ… distç›®å½•å­˜åœ¨'
              echo 'æ–‡ä»¶æ•°é‡:' \$(find /home/fuint/frontsite/dist -type f | wc -l)
              echo 'ä¸»è¦æ–‡ä»¶:'
              ls -la /home/fuint/frontsite/dist/ | head -10
            else
              echo 'âŒ distç›®å½•ä¸å­˜åœ¨'
            fi
          "

          echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆ"

      - name: Post-deployment tasks
        run: |
          echo "=== éƒ¨ç½²æˆåŠŸ ==="
          echo "ğŸ‰ CI/CD éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "é¡¹ç›®å·²éƒ¨ç½²åˆ°: 192.168.1.78:/home/fuint/frontsite"
          echo "éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "Commit: ${{ github.sha }}"
