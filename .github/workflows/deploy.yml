name: CI/CD Pipeline
on:
  push:
    branches: [main]

jobs:
  build-test:
    name: Build and Test
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          pnpm install
          echo "ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Run tests
        run: pnpm run test:unit
        env:
          CI: true

      - name: Build project
        run: |
          pnpm run build
          echo "æž„å»ºå®Œæˆï¼Œäº§ç‰©å¤§å°ï¼š"
          du -sh dist/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            dist/
            !dist/**/*.map
          retention-days: 7

  deploy:
    name: Deploy to Production
    needs: build-test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build

      - name: Verify artifacts
        run: |
          echo "ä¸‹è½½çš„äº§ç‰©å†…å®¹ï¼š"
          ls -la
          echo "æ–‡ä»¶æ€»æ•°ï¼š$(find . -type f | wc -l)"

      - name: Setup and Verify SSH Key
        id: ssh-setup
        run: |
          echo "=== é…ç½®å¹¶éªŒè¯SSHå¯†é’¥ ==="

          # 1. åˆ›å»ºç›®å½•
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # 2. å†™å…¥ç§é’¥
          echo "å†™å…¥ç§é’¥æ–‡ä»¶..."
          cat > ~/.ssh/id_ed25519 << 'EOF'
          ${{ secrets.DEPLOY_SSH_KEY }}
          EOF

          # 3. éªŒè¯ç§é’¥æ ¼å¼
          KEY_LINES=$(wc -l < ~/.ssh/id_ed25519)
          echo "ç§é’¥è¡Œæ•°: $KEY_LINES"

          if [ $KEY_LINES -lt 5 ]; then
            echo "âŒ é”™è¯¯ï¼šç§é’¥è¿‡çŸ­ï¼Œå¯èƒ½æ ¼å¼é”™è¯¯"
            exit 1
          fi

          # 4. éªŒè¯å¯†é’¥æœ‰æ•ˆæ€§
          echo "éªŒè¯å¯†é’¥æœ‰æ•ˆæ€§..."
          if ssh-keygen -l -f ~/.ssh/id_ed25519 2>/dev/null; then
            echo "âœ… ç§é’¥æ ¼å¼æœ‰æ•ˆ"
          else
            echo "âŒ ç§é’¥æ ¼å¼æ— æ•ˆ"
            exit 1
          fi

          # 5. è®¾ç½®æƒé™
          chmod 600 ~/.ssh/id_ed25519

          # 6. é…ç½®SSH
          cat > ~/.ssh/config << 'EOF'
            Host 192.168.1.78
            HostName 192.168.1.78
            User fuint
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ConnectTimeout 10
          EOF

          # 7. é¦–æ¬¡è¿žæŽ¥æµ‹è¯•
          echo "é¦–æ¬¡SSHè¿žæŽ¥æµ‹è¯•..."
          ssh -o ConnectTimeout=5 fuint@192.168.1.78 "echo 'âœ… åŸºç¡€è¿žæŽ¥æµ‹è¯•æˆåŠŸ'" || {
            echo "âš ï¸ é¦–æ¬¡è¿žæŽ¥å¯èƒ½å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ..."
          }

          echo "SSHé…ç½®å®Œæˆ"

      - name: Deploy files
        env:
          DEPLOY_HOST: 192.168.1.78
          DEPLOY_USER: fuint
          DEPLOY_PATH: /home/fuint/frontsite
        run: |
          echo "å¼€å§‹éƒ¨ç½²åˆ° $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH"

          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          ssh -i ~/.ssh/id_ed25519 $DEPLOY_USER@$DEPLOY_HOST "mkdir -p $DEPLOY_PATH"

          # ä½¿ç”¨rsyncåŒæ­¥
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no" \
            --exclude='.git*' \
            --exclude='*.log' \
            ./ \
            $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/

          echo "æ–‡ä»¶åŒæ­¥å®Œæˆ"

      - name: Post-deployment verification
        run: |
          ssh -i ~/.ssh/id_ed25519 fuint@192.168.1.78 "
            echo '=== éƒ¨ç½²éªŒè¯ ==='
            echo 'ç›®æ ‡ç›®å½•: $DEPLOY_PATH'
            echo 'ç›®å½•å¤§å°:'
            du -sh $DEPLOY_PATH
            echo ''
            echo 'æœ€è¿‘ä¿®æ”¹çš„5ä¸ªæ–‡ä»¶:'
            find $DEPLOY_PATH -type f -printf '%T+ %p\n' | sort -r | head -5
            echo ''
            echo 'éƒ¨ç½²æ—¶é—´: $(date)'
          "

      - name: Notification
        run: |
          echo "ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼"
          echo "é¡¹ç›®å·²æˆåŠŸéƒ¨ç½²åˆ° 192.168.1.78"
          echo "è®¿é—®åœ°å€: http://192.168.1.78 (å¦‚æžœé…ç½®äº†WebæœåŠ¡å™¨)"
